<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Data - SHM Dashboard</title>
    
    <!-- Bootstrap CSS with Replit dark theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .badge-anomaly {
            background-color: #dc3545;
        }
        .badge-normal {
            background-color: #198754;
        }
        .badge-warning {
            background-color: #ffc107;
        }
        .badge-critical {
            background-color: #dc3545;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
        .export-controls {
            background-color: var(--bs-secondary-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        .filter-controls {
            background-color: var(--bs-secondary-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">
                <strong>SHM Dashboard</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('main.dashboard') }}">Live Dashboard</a>
                <a class="nav-link active" href="{{ url_for('history.history_dashboard') }}">History</a>
                <!-- <a class="nav-link" href="/apidocs/">API Docs</a> -->
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 text-center mb-1">Historical Data Dashboard</h1>
                <p class="text-center text-muted">Analyze past sensor readings and system performance</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Readings</h5>
                        <h3 class="text-primary mb-0">{{ stats.total_readings or 0 }}</h3>
                        <small class="text-muted">Last 24 hours</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Anomalies</h5>
                        <h3 class="text-warning mb-0">{{ stats.anomalies or 0 }}</h3>
                        <small class="text-muted">Detected</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Alerts</h5>
                        <h3 class="text-danger mb-0">{{ stats.alerts or 0 }}</h3>
                        <small class="text-muted">Triggered</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Avg Temperature</h5>
                        <h3 class="text-info mb-0">{{ stats.avg_temperature or 0 }}°C</h3>
                        <small class="text-muted">24h average</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Historical Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="historicalChart"></canvas>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <select id="periodSelect" class="form-select">
                                    <option value="hour">Hourly</option>
                                    <option value="day" selected>Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select id="daysSelect" class="form-select">
                                    <option value="1">Last 1 day</option>
                                    <option value="7" selected>Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="export-controls">
                    <h6>Export Data</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="exportStartDate" class="form-label">Start Date</label>
                            <input type="date" id="exportStartDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="exportEndDate" class="form-label">End Date</label>
                            <input type="date" id="exportEndDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button id="exportBtn" class="btn btn-success form-control">Export CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-controls">
                    <h6>Filter Data</h6>
                    <div class="row">
                        <div class="col-md-2">
                            <label for="filterStartDate" class="form-label">Start Date</label>
                            <input type="date" id="filterStartDate" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="filterEndDate" class="form-label">End Date</label>
                            <input type="date" id="filterEndDate" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="alertLevelFilter" class="form-label">Alert Level</label>
                            <select id="alertLevelFilter" class="form-select">
                                <option value="">All</option>
                                <option value="normal">Normal</option>
                                <option value="warning">Warning</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check" style="margin-top: 2rem;">
                                <input class="form-check-input" type="checkbox" id="anomaliesOnly">
                                <label class="form-check-label" for="anomaliesOnly">
                                    Anomalies Only
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button id="filterBtn" class="btn btn-primary form-control">Apply Filter</button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button id="clearFilterBtn" class="btn btn-outline-secondary form-control">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Historical Readings</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Timestamp</th>
                                        <th>Vibration</th>
                                        <th>Strain</th>
                                        <th>Temperature</th>
                                        <th>Anomaly</th>
                                        <th>Alert Level</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be loaded here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        let historicalChart;
        let currentPage = 1;
        const perPage = 50;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadHistoricalData();
            loadTableData();
            setupEventListeners();
        });
        
        function initializeChart() {
            const ctx = document.getElementById('historicalChart').getContext('2d');
            historicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function loadHistoricalData() {
            const period = document.getElementById('periodSelect').value;
            const days = document.getElementById('daysSelect').value;
            
            fetch(`/history/charts?period=${period}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    historicalChart.data.labels = data.labels;
                    historicalChart.data.datasets = data.datasets;
                    historicalChart.update();
                })
                .catch(error => {
                    console.error('Error loading historical data:', error);
                });
        }
        
        function loadTableData(page = 1) {
            currentPage = page;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const alertLevel = document.getElementById('alertLevelFilter').value;
            const anomaliesOnly = document.getElementById('anomaliesOnly').checked;
            
            let url = `/history/data?page=${page}&per_page=${perPage}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (alertLevel) url += `&alert_level=${alertLevel}`;
            if (anomaliesOnly) url += `&anomalies_only=true`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayTableData(data.readings);
                    updatePagination(data.page, data.pages, data.total);
                })
                .catch(error => {
                    console.error('Error loading table data:', error);
                });
        }
        
        function displayTableData(readings) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            readings.forEach(reading => {
                const row = document.createElement('tr');
                
                // Alert level badge
                const alertBadge = `<span class="badge badge-${reading.alert_level}">${reading.alert_level}</span>`;
                
                // Anomaly badge
                const anomalyBadge = reading.is_anomaly ? 
                    '<span class="badge badge-anomaly">Anomaly</span>' : 
                    '<span class="badge badge-normal">Normal</span>';
                
                row.innerHTML = `
                    <td>${reading.id}</td>
                    <td>${new Date(reading.timestamp).toLocaleString()}</td>
                    <td>${reading.vibration}</td>
                    <td>${reading.strain}</td>
                    <td>${reading.temperature}°C</td>
                    <td>${anomalyBadge}</td>
                    <td>${alertBadge}</td>
                    <td>${reading.anomaly_score.toFixed(3)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updatePagination(page, pages, total) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous button
            if (page > 1) {
                const prevItem = document.createElement('li');
                prevItem.className = 'page-item';
                prevItem.innerHTML = `<a class="page-link" href="#" onclick="loadTableData(${page - 1})">Previous</a>`;
                pagination.appendChild(prevItem);
            }
            
            // Page numbers
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                pageItem.innerHTML = `<a class="page-link" href="#" onclick="loadTableData(${i})">${i}</a>`;
                pagination.appendChild(pageItem);
            }
            
            // Next button
            if (page < pages) {
                const nextItem = document.createElement('li');
                nextItem.className = 'page-item';
                nextItem.innerHTML = `<a class="page-link" href="#" onclick="loadTableData(${page + 1})">Next</a>`;
                pagination.appendChild(nextItem);
            }
        }
        
        function setupEventListeners() {
            // Chart controls
            document.getElementById('periodSelect').addEventListener('change', loadHistoricalData);
            document.getElementById('daysSelect').addEventListener('change', loadHistoricalData);
            
            // Filter controls
            document.getElementById('filterBtn').addEventListener('click', () => loadTableData(1));
            document.getElementById('clearFilterBtn').addEventListener('click', clearFilters);
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportData);
        }
        
        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('alertLevelFilter').value = '';
            document.getElementById('anomaliesOnly').checked = false;
            loadTableData(1);
        }
        
        function exportData() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            let url = '/history/export';
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
    </script>
</body>
</html>